<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTTM Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #1d1d1f;
            font-weight: 600;
            font-size: 28px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .file-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .file-input-group {
            flex: 1;
            min-width: 250px;
        }

        .file-input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .file-input-group input[type="file"] {
            width: 100%;
            padding: 14px;
            background: #fff;
            border: 2px dashed #86868b;
            border-radius: 12px;
            color: #1d1d1f;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 14px;
        }

        .file-input-group input[type="file"]:hover {
            border-color: #0071e3;
            background: #f0f7ff;
        }

        .player-section {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #0071e3;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px rgba(0,113,227,0.3);
        }

        .play-btn:hover {
            background: #0077ed;
            transform: scale(1.05);
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        .play-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .time-display {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 16px;
            color: #1d1d1f;
            font-weight: 500;
            min-width: 140px;
        }

        .current-speaker-display {
            flex: 1;
            text-align: center;
            padding: 8px 16px;
            background: #f5f5f7;
            border-radius: 12px;
        }

        .current-speaker-label {
            font-size: 11px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .current-speaker-name {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .current-speaker-name.speaking {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .current-speaker-name .speaker-dot {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .no-speaker {
            color: #86868b;
            font-weight: 400;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-control label {
            font-size: 14px;
            color: #86868b;
            font-weight: 500;
        }

        .speed-control select {
            background: #f5f5f7;
            border: 1px solid #d2d2d7;
            color: #1d1d1f;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .speed-control select:hover {
            border-color: #0071e3;
        }

        .timeline-container {
            position: relative;
            background: #e8e8ed;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
        }

        .timeline-track {
            height: 64px;
            position: relative;
        }

        .waveform-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #86868b;
            font-size: 14px;
            pointer-events: none;
            font-weight: 500;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ff3b30;
            pointer-events: none;
            z-index: 100;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            width: 15px;
            height: 15px;
            background: #ff3b30;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(255,59,48,0.4);
        }

        .scrub-bar {
            height: 6px;
            background: #d2d2d7;
        }

        .scrub-progress {
            height: 100%;
            background: #0071e3;
            width: 0%;
            transition: width 0.05s linear;
        }

        .diarization-view {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .diarization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .diarization-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .speaker-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .tracks-container {
            position: relative;
            min-height: 200px;
        }

        .speaker-track {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .speaker-label {
            width: 120px;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            flex-shrink: 0;
        }

        .speaker-timeline {
            flex: 1;
            height: 36px;
            background: #f5f5f7;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e8e8ed;
        }

        .segment {
            position: absolute;
            top: 3px;
            bottom: 3px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .segment:hover {
            transform: scaleY(1.15);
            z-index: 10;
        }

        .segment.active {
            box-shadow: 0 0 0 3px rgba(0,0,0,0.4);
            z-index: 20;
            transform: scaleY(1.15);
        }

        .segment-tooltip {
            position: fixed;
            background: #1d1d1f;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .zoom-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .zoom-btn {
            background: #f5f5f7;
            border: 1px solid #d2d2d7;
            color: #1d1d1f;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .zoom-btn:hover {
            background: #e8e8ed;
            border-color: #0071e3;
        }

        .zoom-level {
            font-size: 13px;
            color: #86868b;
            min-width: 50px;
            text-align: center;
            font-weight: 500;
        }

        .stats {
            display: flex;
            gap: 40px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e8e8ed;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #0071e3;
        }

        .stat-label {
            font-size: 13px;
            color: #86868b;
            margin-top: 4px;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .empty-state p {
            font-size: 15px;
            font-weight: 500;
        }

        .keyboard-shortcuts {
            margin-top: 24px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .keyboard-shortcuts h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #1d1d1f;
            font-weight: 600;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #1d1d1f;
        }

        .shortcut kbd {
            background: #f5f5f7;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            border: 1px solid #d2d2d7;
            font-weight: 500;
        }

        /* Speaker colors - vibrant and high contrast */
        .speaker-0, .color-0 { background: #ff3b30; }
        .speaker-1, .color-1 { background: #34c759; }
        .speaker-2, .color-2 { background: #007aff; }
        .speaker-3, .color-3 { background: #ff9500; }
        .speaker-4, .color-4 { background: #af52de; }
        .speaker-5, .color-5 { background: #00c7be; }
        .speaker-6, .color-6 { background: #ff2d55; }
        .speaker-7, .color-7 { background: #5856d6; }
        .speaker-8, .color-8 { background: #ffcc00; }
        .speaker-9, .color-9 { background: #64d2ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>RTTM Viewer</h1>

        <div class="file-inputs">
            <div class="file-input-group">
                <label>Audio File (WAV, MP3, etc.)</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>
            <div class="file-input-group">
                <label>RTTM File</label>
                <input type="file" id="rttmFile" accept=".rttm,.txt">
            </div>
        </div>

        <div class="player-section">
            <div class="controls">
                <button class="play-btn" id="playBtn" disabled>
                    <span id="playIcon">▶</span>
                </button>
                <div class="time-display">
                    <span id="currentTime">0:00.0</span> / <span id="totalTime">0:00.0</span>
                </div>
                
                <div class="current-speaker-display">
                    <div class="current-speaker-label">Currently Speaking</div>
                    <div class="current-speaker-name" id="currentSpeaker">
                        <span class="no-speaker">—</span>
                    </div>
                </div>

                <div class="speed-control">
                    <label>Speed:</label>
                    <select id="speedSelect">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
            </div>

            <div class="timeline-container" id="timelineContainer">
                <div class="timeline-track" id="timelineTrack">
                    <div class="waveform-placeholder">Load an audio file to begin</div>
                    <div class="playhead" id="playhead" style="left: 0"></div>
                </div>
                <div class="scrub-bar">
                    <div class="scrub-progress" id="scrubProgress"></div>
                </div>
            </div>
        </div>

        <div class="diarization-view">
            <div class="diarization-header">
                <h2>Speaker Diarization</h2>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut">−</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">+</button>
                </div>
            </div>

            <div class="speaker-legend" id="speakerLegend"></div>

            <div class="tracks-container" id="tracksContainer">
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" x2="12" y1="19" y2="22"/>
                    </svg>
                    <p>Load an RTTM file to visualize speaker diarization</p>
                </div>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat">
                    <div class="stat-value" id="statSpeakers">0</div>
                    <div class="stat-label">Speakers</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statSegments">0</div>
                    <div class="stat-label">Segments</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statDuration">0:00</div>
                    <div class="stat-label">Total Speech</div>
                </div>
            </div>
        </div>

        <div class="keyboard-shortcuts">
            <h3>Keyboard Shortcuts</h3>
            <div class="shortcuts-grid">
                <div class="shortcut"><kbd>Space</kbd> Play / Pause</div>
                <div class="shortcut"><kbd>←</kbd> Back 5s</div>
                <div class="shortcut"><kbd>→</kbd> Forward 5s</div>
                <div class="shortcut"><kbd>J</kbd> Back 10s</div>
                <div class="shortcut"><kbd>L</kbd> Forward 10s</div>
                <div class="shortcut"><kbd>Home</kbd> Go to start</div>
            </div>
        </div>
    </div>

    <div class="segment-tooltip" id="tooltip"></div>

    <audio id="audioPlayer"></audio>

    <script>
        // State
        let segments = [];
        let speakers = [];
        let speakerColors = {};
        let duration = 0;
        let zoom = 1;
        let isPlaying = false;

        // Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const audioFileInput = document.getElementById('audioFile');
        const rttmFileInput = document.getElementById('rttmFile');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const currentSpeakerEl = document.getElementById('currentSpeaker');
        const speedSelect = document.getElementById('speedSelect');
        const timelineContainer = document.getElementById('timelineContainer');
        const timelineTrack = document.getElementById('timelineTrack');
        const playhead = document.getElementById('playhead');
        const scrubProgress = document.getElementById('scrubProgress');
        const tracksContainer = document.getElementById('tracksContainer');
        const speakerLegend = document.getElementById('speakerLegend');
        const emptyState = document.getElementById('emptyState');
        const stats = document.getElementById('stats');
        const tooltip = document.getElementById('tooltip');
        const zoomIn = document.getElementById('zoomIn');
        const zoomOut = document.getElementById('zoomOut');
        const zoomLevel = document.getElementById('zoomLevel');

        // Format time as M:SS.s
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins}:${secs.padStart(4, '0')}`;
        }

        // Parse RTTM file
        function parseRTTM(text) {
            const lines = text.trim().split('\n');
            const parsed = [];
            
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts[0] === 'SPEAKER' && parts.length >= 8) {
                    parsed.push({
                        start: parseFloat(parts[3]),
                        duration: parseFloat(parts[4]),
                        speaker: parts[7]
                    });
                }
            }
            
            return parsed;
        }

        // Get unique speakers sorted
        function getSpeakers(segments) {
            const unique = [...new Set(segments.map(s => s.speaker))];
            return unique.sort((a, b) => {
                const numA = parseInt(a.replace(/\D/g, ''));
                const numB = parseInt(b.replace(/\D/g, ''));
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
        }

        // Build speaker color map
        function buildSpeakerColors() {
            speakerColors = {};
            speakers.forEach((speaker, i) => {
                speakerColors[speaker] = i % 10;
            });
        }

        // Get current speaker(s) at a given time
        function getCurrentSpeakers(time) {
            return segments.filter(s => time >= s.start && time <= s.start + s.duration)
                          .map(s => s.speaker);
        }

        // Update current speaker display
        function updateCurrentSpeaker() {
            const currentSpeakers = getCurrentSpeakers(audioPlayer.currentTime);
            
            if (currentSpeakers.length === 0) {
                currentSpeakerEl.innerHTML = '<span class="no-speaker">—</span>';
                currentSpeakerEl.classList.remove('speaking');
            } else if (currentSpeakers.length === 1) {
                const speaker = currentSpeakers[0];
                const colorClass = `color-${speakerColors[speaker]}`;
                currentSpeakerEl.innerHTML = `<span class="speaker-dot ${colorClass}"></span>${speaker}`;
                currentSpeakerEl.classList.add('speaking');
            } else {
                // Multiple speakers (overlap)
                const speakerHtml = currentSpeakers.map(speaker => {
                    const colorClass = `color-${speakerColors[speaker]}`;
                    return `<span class="speaker-dot ${colorClass}"></span>${speaker}`;
                }).join(' <span style="color:#86868b">+</span> ');
                currentSpeakerEl.innerHTML = speakerHtml;
                currentSpeakerEl.classList.add('speaking');
            }
        }

        // Render speaker legend
        function renderLegend() {
            speakerLegend.innerHTML = speakers.map((speaker, i) => `
                <div class="legend-item">
                    <div class="legend-color speaker-${i % 10}"></div>
                    <span>${speaker}</span>
                </div>
            `).join('');
        }

        // Render diarization tracks
        function renderTracks() {
            if (segments.length === 0) {
                emptyState.style.display = 'block';
                stats.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            stats.style.display = 'flex';

            const maxTime = duration || Math.max(...segments.map(s => s.start + s.duration));
            
            let html = '';
            for (let i = 0; i < speakers.length; i++) {
                const speaker = speakers[i];
                const speakerSegments = segments.filter(s => s.speaker === speaker);
                
                html += `
                    <div class="speaker-track">
                        <div class="speaker-label">${speaker}</div>
                        <div class="speaker-timeline" data-speaker="${speaker}">
                            ${speakerSegments.map(seg => {
                                const left = (seg.start / maxTime) * 100;
                                const width = (seg.duration / maxTime) * 100;
                                return `<div class="segment speaker-${i % 10}" 
                                    style="left: ${left}%; width: ${width}%"
                                    data-start="${seg.start}"
                                    data-duration="${seg.duration}"
                                    data-speaker="${speaker}"></div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            tracksContainer.innerHTML = html;

            // Update stats
            document.getElementById('statSpeakers').textContent = speakers.length;
            document.getElementById('statSegments').textContent = segments.length;
            const totalSpeech = segments.reduce((sum, s) => sum + s.duration, 0);
            document.getElementById('statDuration').textContent = formatTime(totalSpeech);

            // Add segment event listeners
            document.querySelectorAll('.segment').forEach(el => {
                el.addEventListener('click', () => {
                    const start = parseFloat(el.dataset.start);
                    audioPlayer.currentTime = start;
                    updatePlayhead();
                });

                el.addEventListener('mouseenter', (e) => {
                    const start = parseFloat(el.dataset.start);
                    const dur = parseFloat(el.dataset.duration);
                    const speaker = el.dataset.speaker;
                    tooltip.innerHTML = `<strong>${speaker}</strong><br>${formatTime(start)} → ${formatTime(start + dur)} (${dur.toFixed(2)}s)`;
                    tooltip.style.display = 'block';
                });

                el.addEventListener('mousemove', (e) => {
                    tooltip.style.left = e.clientX + 12 + 'px';
                    tooltip.style.top = e.clientY + 12 + 'px';
                });

                el.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // Update playhead position
        function updatePlayhead() {
            if (duration === 0) return;
            
            const progress = audioPlayer.currentTime / duration;
            playhead.style.left = `${progress * 100}%`;
            scrubProgress.style.width = `${progress * 100}%`;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);

            // Update current speaker display
            updateCurrentSpeaker();

            // Highlight active segments
            document.querySelectorAll('.segment').forEach(el => {
                const start = parseFloat(el.dataset.start);
                const dur = parseFloat(el.dataset.duration);
                const isActive = audioPlayer.currentTime >= start && audioPlayer.currentTime <= start + dur;
                el.classList.toggle('active', isActive);
            });
        }

        // Handle audio file selection
        audioFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            
            audioPlayer.addEventListener('loadedmetadata', () => {
                duration = audioPlayer.duration;
                totalTimeEl.textContent = formatTime(duration);
                playBtn.disabled = false;
                timelineTrack.querySelector('.waveform-placeholder').textContent = file.name;
                renderTracks();
            }, { once: true });
        });

        // Handle RTTM file selection
        rttmFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                segments = parseRTTM(event.target.result);
                speakers = getSpeakers(segments);
                buildSpeakerColors();
                renderLegend();
                renderTracks();
                updateCurrentSpeaker();
            };
            reader.readAsText(file);
        });

        // Play/pause
        playBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            playIcon.textContent = '⏸';
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            playIcon.textContent = '▶';
        });

        audioPlayer.addEventListener('timeupdate', updatePlayhead);

        // Speed control
        speedSelect.addEventListener('change', () => {
            audioPlayer.playbackRate = parseFloat(speedSelect.value);
        });

        // Timeline scrubbing
        timelineContainer.addEventListener('click', (e) => {
            if (duration === 0) return;
            const rect = timelineContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const progress = x / rect.width;
            audioPlayer.currentTime = progress * duration;
            updatePlayhead();
        });

        // Zoom controls
        zoomIn.addEventListener('click', () => {
            zoom = Math.min(zoom * 1.5, 10);
            zoomLevel.textContent = Math.round(zoom * 100) + '%';
            tracksContainer.style.width = (zoom * 100) + '%';
        });

        zoomOut.addEventListener('click', () => {
            zoom = Math.max(zoom / 1.5, 1);
            zoomLevel.textContent = Math.round(zoom * 100) + '%';
            tracksContainer.style.width = (zoom * 100) + '%';
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    playBtn.click();
                    break;
                case 'ArrowLeft':
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
                case 'ArrowRight':
                    audioPlayer.currentTime = Math.min(duration, audioPlayer.currentTime + 5);
                    break;
                case 'KeyJ':
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
                    break;
                case 'KeyL':
                    audioPlayer.currentTime = Math.min(duration, audioPlayer.currentTime + 10);
                    break;
                case 'Home':
                    audioPlayer.currentTime = 0;
                    break;
            }
        });
    </script>
</body>
</html>
