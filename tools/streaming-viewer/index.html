<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Diarization Viewer</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #1d1d1f;
            font-weight: 600;
            font-size: 28px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .upload-section {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .file-input-group {
            margin-bottom: 16px;
        }

        .file-input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .file-input-group input[type="file"] {
            width: 100%;
            padding: 14px;
            background: #fff;
            border: 2px dashed #86868b;
            border-radius: 12px;
            color: #1d1d1f;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            font-size: 14px;
        }

        .file-input-group input[type="file"]:hover {
            border-color: #0071e3;
            background: #f0f7ff;
        }

        .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .start-btn {
            padding: 14px 32px;
            border-radius: 12px;
            border: none;
            background: #0071e3;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px rgba(0,113,227,0.3);
        }

        .start-btn:hover {
            background: #0077ed;
            transform: scale(1.02);
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        .start-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 14px;
            color: #86868b;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #86868b;
        }

        .status-dot.connected {
            background: #34c759;
        }

        .status-dot.processing {
            background: #ff9500;
            animation: pulse 1s infinite;
        }

        .status-dot.error {
            background: #ff3b30;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .player-section {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #0071e3;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px rgba(0,113,227,0.3);
        }

        .play-btn:hover {
            background: #0077ed;
            transform: scale(1.05);
        }

        .play-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .time-display {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 16px;
            color: #1d1d1f;
            font-weight: 500;
            min-width: 140px;
        }

        .progress-info {
            flex: 1;
            text-align: center;
        }

        .progress-label {
            font-size: 11px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .progress-text {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .timeline-container {
            position: relative;
            background: #e8e8ed;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
        }

        .timeline-track {
            height: 64px;
            position: relative;
        }

        .waveform-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #86868b;
            font-size: 14px;
            pointer-events: none;
            font-weight: 500;
        }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ff3b30;
            pointer-events: none;
            z-index: 100;
            left: 0;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            width: 15px;
            height: 15px;
            background: #ff3b30;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(255,59,48,0.4);
        }

        .scrub-bar {
            height: 6px;
            background: #d2d2d7;
        }

        .scrub-progress {
            height: 100%;
            background: #0071e3;
            width: 0%;
            transition: width 0.05s linear;
        }

        .diarization-view {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .diarization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .diarization-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .recluster-indicator {
            display: none;
            padding: 8px 16px;
            background: #ff9500;
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            animation: flash 0.5s ease-in-out;
        }

        .recluster-indicator.active {
            display: block;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; transform: scale(1.05); }
        }

        .speaker-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            min-height: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .tracks-container {
            position: relative;
            min-height: 200px;
        }

        .speaker-track {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .speaker-label {
            width: 120px;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            flex-shrink: 0;
        }

        .speaker-timeline {
            flex: 1;
            height: 36px;
            background: #f5f5f7;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e8e8ed;
        }

        .segment {
            position: absolute;
            top: 3px;
            bottom: 3px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            opacity: 0;
            animation: segmentAppear 0.3s forwards;
        }

        @keyframes segmentAppear {
            from {
                opacity: 0;
                transform: scaleY(0.5);
            }
            to {
                opacity: 1;
                transform: scaleY(1);
            }
        }

        .segment:hover {
            transform: scaleY(1.15);
            z-index: 10;
        }

        .segment.active {
            box-shadow: 0 0 0 3px rgba(0,0,0,0.4);
            z-index: 20;
            transform: scaleY(1.15);
        }

        .segment-tooltip {
            position: fixed;
            background: #1d1d1f;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .empty-state p {
            font-size: 15px;
            font-weight: 500;
        }

        .stats {
            display: flex;
            gap: 40px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e8e8ed;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #0071e3;
        }

        .stat-label {
            font-size: 13px;
            color: #86868b;
            margin-top: 4px;
            font-weight: 500;
        }

        .keyboard-shortcuts {
            margin-top: 24px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .keyboard-shortcuts h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #1d1d1f;
            font-weight: 600;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #1d1d1f;
        }

        .shortcut kbd {
            background: #f5f5f7;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            border: 1px solid #d2d2d7;
            font-weight: 500;
        }

        .speaker-0, .color-0 { background: #ff3b30; }
        .speaker-1, .color-1 { background: #34c759; }
        .speaker-2, .color-2 { background: #007aff; }
        .speaker-3, .color-3 { background: #ff9500; }
        .speaker-4, .color-4 { background: #af52de; }
        .speaker-5, .color-5 { background: #00c7be; }
        .speaker-6, .color-6 { background: #ff2d55; }
        .speaker-7, .color-7 { background: #5856d6; }
        .speaker-8, .color-8 { background: #ffcc00; }
        .speaker-9, .color-9 { background: #64d2ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Streaming Diarization Viewer</h1>

        <div class="upload-section">
            <div class="file-input-group">
                <label>WAV Audio File (16kHz mono)</label>
                <input type="file" id="audioFile" accept=".wav">
            </div>
            <div class="controls">
                <button class="start-btn" id="startBtn" disabled>Start Streaming</button>
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
        </div>

        <div class="player-section">
            <div class="player-controls">
                <button class="play-btn" id="playBtn" disabled>
                    <span id="playIcon">▶</span>
                </button>
                <div class="time-display">
                    <span id="currentTime">0:00.0</span> / <span id="totalTime">0:00.0</span>
                </div>
                <div class="progress-info">
                    <div class="progress-label">Processing</div>
                    <div class="progress-text" id="progressText">Waiting for file...</div>
                </div>
            </div>

            <div class="timeline-container" id="timelineContainer">
                <div class="timeline-track" id="timelineTrack">
                    <div class="waveform-placeholder" id="waveformPlaceholder">Upload a WAV file to begin</div>
                    <div class="playhead" id="playhead"></div>
                </div>
                <div class="scrub-bar">
                    <div class="scrub-progress" id="scrubProgress"></div>
                </div>
            </div>
        </div>

        <div class="diarization-view">
            <div class="diarization-header">
                <h2>Speaker Diarization</h2>
                <div class="recluster-indicator" id="reclusterIndicator">Reclustering...</div>
            </div>

            <div class="speaker-legend" id="speakerLegend"></div>

            <div class="tracks-container" id="tracksContainer">
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" x2="12" y1="19" y2="22"/>
                    </svg>
                    <p>Start streaming to see real-time diarization</p>
                </div>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat">
                    <div class="stat-value" id="statSpeakers">0</div>
                    <div class="stat-label">Speakers</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statSegments">0</div>
                    <div class="stat-label">Segments</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statChunks">0</div>
                    <div class="stat-label">Chunks Processed</div>
                </div>
            </div>
        </div>

        <div class="keyboard-shortcuts">
            <h3>Keyboard Shortcuts</h3>
            <div class="shortcuts-grid">
                <div class="shortcut"><kbd>Space</kbd> Play / Pause</div>
                <div class="shortcut"><kbd>←</kbd> Back 5s</div>
                <div class="shortcut"><kbd>→</kbd> Forward 5s</div>
                <div class="shortcut"><kbd>Home</kbd> Go to start</div>
            </div>
        </div>
    </div>

    <div class="segment-tooltip" id="tooltip"></div>
    <audio id="audioPlayer"></audio>

    <script>
        let socket = null;
        let fileId = null;
        let segments = [];
        let speakers = new Set();
        let speakerColors = {};
        let duration = 0;
        let chunksProcessed = 0;
        let isPlaying = false;

        const audioPlayer = document.getElementById('audioPlayer');
        const audioFileInput = document.getElementById('audioFile');
        const startBtn = document.getElementById('startBtn');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const progressText = document.getElementById('progressText');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const timelineContainer = document.getElementById('timelineContainer');
        const playhead = document.getElementById('playhead');
        const scrubProgress = document.getElementById('scrubProgress');
        const tracksContainer = document.getElementById('tracksContainer');
        const speakerLegend = document.getElementById('speakerLegend');
        const emptyState = document.getElementById('emptyState');
        const stats = document.getElementById('stats');
        const tooltip = document.getElementById('tooltip');
        const reclusterIndicator = document.getElementById('reclusterIndicator');
        const waveformPlaceholder = document.getElementById('waveformPlaceholder');

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(1);
            return `${mins}:${secs.padStart(4, '0')}`;
        }

        function getSpeakerColorIndex(speaker) {
            if (!(speaker in speakerColors)) {
                speakerColors[speaker] = Object.keys(speakerColors).length % 10;
            }
            return speakerColors[speaker];
        }

        function renderLegend() {
            speakerLegend.innerHTML = Array.from(speakers).sort().map((speaker, i) => `
                <div class="legend-item" style="animation-delay: ${i * 0.1}s">
                    <div class="legend-color speaker-${getSpeakerColorIndex(speaker)}"></div>
                    <span>${speaker}</span>
                </div>
            `).join('');
        }

        function renderTracks() {
            if (segments.length === 0) {
                emptyState.style.display = 'block';
                stats.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            stats.style.display = 'flex';

            const maxTime = duration || Math.max(...segments.map(s => s.start + s.duration), 1);
            const sortedSpeakers = Array.from(speakers).sort();

            let html = '';
            for (const speaker of sortedSpeakers) {
                const speakerSegments = segments.filter(s => s.speaker === speaker);
                const colorIdx = getSpeakerColorIndex(speaker);

                html += `
                    <div class="speaker-track">
                        <div class="speaker-label">${speaker}</div>
                        <div class="speaker-timeline" data-speaker="${speaker}">
                            ${speakerSegments.map((seg, i) => {
                                const left = (seg.start / maxTime) * 100;
                                const width = (seg.duration / maxTime) * 100;
                                return `<div class="segment speaker-${colorIdx}" 
                                    style="left: ${left}%; width: ${width}%; animation-delay: ${i * 0.02}s"
                                    data-start="${seg.start}"
                                    data-duration="${seg.duration}"
                                    data-speaker="${speaker}"></div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            tracksContainer.innerHTML = html;

            document.getElementById('statSpeakers').textContent = speakers.size;
            document.getElementById('statSegments').textContent = segments.length;
            document.getElementById('statChunks').textContent = chunksProcessed;

            addSegmentListeners();
        }

        function addSegmentListeners() {
            document.querySelectorAll('.segment').forEach(el => {
                el.addEventListener('click', () => {
                    const start = parseFloat(el.dataset.start);
                    audioPlayer.currentTime = start;
                    updatePlayhead();
                });

                el.addEventListener('mouseenter', (e) => {
                    const start = parseFloat(el.dataset.start);
                    const dur = parseFloat(el.dataset.duration);
                    const speaker = el.dataset.speaker;
                    tooltip.innerHTML = `<strong>${speaker}</strong><br>${formatTime(start)} → ${formatTime(start + dur)} (${dur.toFixed(2)}s)`;
                    tooltip.style.display = 'block';
                });

                el.addEventListener('mousemove', (e) => {
                    tooltip.style.left = e.clientX + 12 + 'px';
                    tooltip.style.top = e.clientY + 12 + 'px';
                });

                el.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        function updatePlayhead() {
            if (duration === 0) return;

            const progress = audioPlayer.currentTime / duration;
            playhead.style.left = `${progress * 100}%`;
            scrubProgress.style.width = `${progress * 100}%`;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);

            document.querySelectorAll('.segment').forEach(el => {
                const start = parseFloat(el.dataset.start);
                const dur = parseFloat(el.dataset.duration);
                const isActive = audioPlayer.currentTime >= start && audioPlayer.currentTime <= start + dur;
                el.classList.toggle('active', isActive);
            });
        }

        function updateSegments(newSegments) {
            segments = newSegments;
            speakers = new Set(segments.map(s => s.speaker));
            renderLegend();
            renderTracks();
        }

        function connectSocket() {
            socket = io();

            socket.on('connect', () => {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            });

            socket.on('disconnect', () => {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Disconnected';
            });

            socket.on('status', (data) => {
                progressText.textContent = data.message;
            });

            socket.on('push', (data) => {
                chunksProcessed = data.chunk;
                progressText.textContent = `Processing chunk ${data.chunk} (${data.time.toFixed(0)}s)...`;
                statusDot.className = 'status-dot processing';
                updateSegments(data.segments);
            });

            socket.on('recluster', (data) => {
                chunksProcessed = data.chunk;
                progressText.textContent = `Reclustering at ${data.time.toFixed(0)}s...`;

                reclusterIndicator.classList.add('active');
                setTimeout(() => {
                    reclusterIndicator.classList.remove('active');
                }, 1500);

                updateSegments(data.segments);
            });

            socket.on('finalize', (data) => {
                progressText.textContent = 'Finalized!';
                statusDot.className = 'status-dot connected';
                updateSegments(data.segments);
            });

            socket.on('complete', (data) => {
                progressText.textContent = 'Complete!';
                statusDot.className = 'status-dot connected';
            });

            socket.on('error', (data) => {
                progressText.textContent = `Error: ${data.message}`;
                statusDot.className = 'status-dot error';
            });
        }

        audioFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            audioPlayer.src = url;

            audioPlayer.addEventListener('loadedmetadata', () => {
                duration = audioPlayer.duration;
                totalTimeEl.textContent = formatTime(duration);
                playBtn.disabled = false;
                waveformPlaceholder.textContent = file.name;
            }, { once: true });

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                fileId = data.file_id;
                startBtn.disabled = false;
                progressText.textContent = 'Ready to stream';
            } catch (err) {
                progressText.textContent = 'Upload failed: ' + err.message;
            }
        });

        startBtn.addEventListener('click', () => {
            if (!fileId || !socket) return;

            segments = [];
            speakers = new Set();
            speakerColors = {};
            chunksProcessed = 0;
            renderTracks();

            socket.emit('start_streaming', { file_id: fileId });
            startBtn.disabled = true;
            progressText.textContent = 'Starting...';
        });

        playBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        });

        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            playIcon.textContent = '⏸';
        });

        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            playIcon.textContent = '▶';
        });

        audioPlayer.addEventListener('timeupdate', updatePlayhead);

        timelineContainer.addEventListener('click', (e) => {
            if (duration === 0) return;
            const rect = timelineContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const progress = x / rect.width;
            audioPlayer.currentTime = progress * duration;
            updatePlayhead();
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    playBtn.click();
                    break;
                case 'ArrowLeft':
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
                case 'ArrowRight':
                    audioPlayer.currentTime = Math.min(duration, audioPlayer.currentTime + 5);
                    break;
                case 'Home':
                    audioPlayer.currentTime = 0;
                    break;
            }
        });

        connectSocket();
    </script>
</body>
</html>
